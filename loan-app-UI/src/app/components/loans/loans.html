// src/app/components/all-loans.html
<div class="loans-container container py-4">
  <div class="header-section mb-4">
    <h4 class="fw-bold mb-2">üíº All Loans</h4>
    <p class="text-muted">Manage and track all your loan applications</p>
  </div>

  <!-- Filters and Search -->
  @if (!isLoading && loans.length > 0) {
    <div class="filters-section mb-4">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="search-box">
            <i class="bi bi-search"></i>
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search by loan ID or amount..."
              [(ngModel)]="searchTerm"
              (input)="filterLoans()"
            />
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="statusFilter" (change)="filterLoans()">
            <option value="">All Status</option>
            <option value="PENDING">Pending</option>
            <option value="APPROVED">Approved</option>
            <option value="ACTIVE">Active</option>
            <option value="REJECTED">Rejected</option>
            <option value="CLOSED">Closed</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="sortBy" (change)="sortLoans()">
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="amount-desc">Highest Amount</option>
            <option value="amount-asc">Lowest Amount</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards mb-4">
      <div class="summary-card">
        <div class="summary-icon">üìä</div>
        <div class="summary-content">
          <div class="summary-label">Total Loans</div>
          <div class="summary-value">{{ loans.length }}</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon">üí∞</div>
        <div class="summary-content">
          <div class="summary-label">Total Amount</div>
          <div class="summary-value">‚Çπ{{ getTotalAmount() | number:'1.0-0' }}</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon">‚úÖ</div>
        <div class="summary-content">
          <div class="summary-label">Active Loans</div>
          <div class="summary-value">{{ getActiveLoansCount() }}</div>
        </div>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3">Loading loans...</p>
    </div>
  }

  <!-- Empty State -->
  @else if (loans.length === 0) {
    <div class="empty-state">
      <div class="empty-icon">üìã</div>
      <h5>No Loans Found</h5>
      <p class="text-muted">You don't have any loans yet. Apply for a new loan to get started.</p>
      <button class="btn btn-primary mt-3" (click)="navigateToApply()">
        <i class="bi bi-plus-circle me-2"></i>Apply for Loan
      </button>
    </div>
  }

  <!-- Loans Grid -->
  @else if (filteredLoans.length === 0) {
    <div class="empty-state">
      <div class="empty-icon">üîç</div>
      <h5>No Results Found</h5>
      <p class="text-muted">Try adjusting your filters or search terms.</p>
      <button class="btn btn-outline-primary mt-3" (click)="clearFilters()">
        Clear Filters
      </button>
    </div>
  }

  @else {
    <div class="loans-grid">
      @for (loan of filteredLoans; track loan.loanId) {
        <div class="loan-card" [class.loan-card-active]="loan.loanStatus === 'ACTIVE'">
          <!-- Card Header -->
          <div class="loan-card-header">
            <div class="loan-id">
              <i class="bi bi-file-text me-2"></i>
              Loan #{{ loan.loanId }}
            </div>
            <span class="status-badge" [class]="'status-' + loan.loanStatus.toLowerCase()">
              {{ loan.loanStatus }}
            </span>
          </div>

          <!-- Card Body -->
          <div class="loan-card-body">
            <div class="loan-amount">
              <div class="amount-label">Sanctioned Amount</div>
              <div class="amount-value">‚Çπ{{ loan.sanctionedAmount | number:'1.0-0' }}</div>
            </div>

            <div class="loan-details">
              <div class="detail-row">
                <span class="detail-label">
                  <i class="bi bi-calendar-event"></i> Start Date
                </span>
                <span class="detail-value">
                  {{ loan.loanStartDate | date:'MMM d, y' }}
                </span>
              </div>

              @if (loan.loanEndDate) {
                <div class="detail-row">
                  <span class="detail-label">
                    <i class="bi bi-calendar-check"></i> End Date
                  </span>
                  <span class="detail-value">
                    {{ loan.loanEndDate | date:'MMM d, y' }}
                  </span>
                </div>
              }

              @if (loan.interestRate) {
                <div class="detail-row">
                  <span class="detail-label">
                    <i class="bi bi-percent"></i> Interest Rate
                  </span>
                  <span class="detail-value">
                    {{ loan.interestRate }}% p.a.
                  </span>
                </div>
              }

              @if (loan.tenure) {
                <div class="detail-row">
                  <span class="detail-label">
                    <i class="bi bi-clock-history"></i> Tenure
                  </span>
                  <span class="detail-value">
                    {{ loan.tenure }} months
                  </span>
                </div>
              }

              @if (loan.emiAmount) {
                <div class="detail-row">
                  <span class="detail-label">
                    <i class="bi bi-cash-coin"></i> EMI Amount
                  </span>
                  <span class="detail-value">
                    ‚Çπ{{ loan.emiAmount | number:'1.0-0' }}
                  </span>
                </div>
              }
            </div>
          </div>

          <!-- Card Footer -->
          <div class="loan-card-footer">
            <button 
              class="btn btn-sm btn-outline-primary" 
              (click)="viewLoanDetails(loan.loanId)"
            >
              <i class="bi bi-eye me-1"></i>View Details
            </button>
            
            @if (loan.loanStatus === 'ACTIVE') {
              <button 
                class="btn btn-sm btn-primary" 
                (click)="makePayment(loan.loanId)"
              >
                <i class="bi bi-credit-card me-1"></i>Pay EMI
              </button>
            }

            @if (loan.loanStatus === 'PENDING') {
              <button 
                class="btn btn-sm btn-outline-danger" 
                (click)="cancelLoan(loan.loanId)"
              >
                <i class="bi bi-x-circle me-1"></i>Cancel
              </button>
            }
          </div>

          <!-- Progress Bar for Active Loans -->
          @if (loan.loanStatus === 'ACTIVE' && loan.paidAmount !== undefined) {
            <div class="loan-progress">
              <div class="progress-info">
                <span class="progress-label">Repayment Progress</span>
                <span class="progress-percentage">
                  {{ getRepaymentProgress(loan) }}%
                </span>
              </div>
              <div class="progress">
                <div 
                  class="progress-bar" 
                  role="progressbar" 
                  [style.width.%]="getRepaymentProgress(loan)"
                  [attr.aria-valuenow]="getRepaymentProgress(loan)"
                  aria-valuemin="0" 
                  aria-valuemax="100"
                ></div>
              </div>
              <div class="progress-details">
                <small>Paid: ‚Çπ{{ loan.paidAmount | number:'1.0-0' }}</small>
                <small>Remaining: ‚Çπ{{ (loan.sanctionedAmount - loan.paidAmount) | number:'1.0-0' }}</small>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Pagination -->
    @if (filteredLoans.length > itemsPerPage) {
      <div class="pagination-section">
        <button 
          class="btn btn-outline-primary"
          [disabled]="currentPage === 1"
          (click)="previousPage()"
        >
          <i class="bi bi-chevron-left"></i> Previous
        </button>
        <span class="page-info">
          Page {{ currentPage }} of {{ getTotalPages() }}
        </span>
        <button 
          class="btn btn-outline-primary"
          [disabled]="currentPage === getTotalPages()"
          (click)="nextPage()"
        >
          Next <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    }
  }
</div>
